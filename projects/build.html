<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&display=swap" rel="stylesheet">
    <title>Prototype</title>
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }

        .square {
            width: 30px;
            height: 30px;
            border-style: solid;
            border-width: 0.5px;
            border-color: rgba(0, 0, 0, 0.1);
            background: #F8F7F2;
        }

        p {
            margin: 0;
        }

        .control-panel {
            position: absolute;
            top: 4em;
            right: 0;
        }

        .navbar-brand {
            font-size: 1rem;
        }

        .form-check {
            margin-bottom: 0;
            padding-left: 0;
        }

        .form-check .form-check-input {
            margin-left: 0;
        }

        .form-check-label {
            font-size: 0.8rem;
        }

        #car {
            position: absolute;
            width: 60px;
            height: 60px;
            top: 35px;
            /* left: 145px; */
        }
    </style>
</head>

<body>
    <nav id="#nav" class="navbar navbar-expand-lg d-flex justify-content-between shadow-sm">
        <a class="navbar-brand mx-2" href="/">Taximan</a>
        <div class="d-flex align-items-center justify-content-center">
            <!-- <div class="form-check mx-1">
                <input onchange="handleFillTypeChange()" class="form-check-input" type="radio" name="fillType"
                    id="fillType1" value="1" checked>
                <label class="form-check-label" for="fillType1">Road</label>
            </div>
            <div class="form-check mx-1">
                <input onchange="handleFillTypeChange()" class="form-check-input" type="radio" name="fillType"
                    id="fillType2" value="2">
                <label class="form-check-label" for="fillType2">Building</label>
            </div> -->
        </div>
        <button onclick="precompute()" class="btn btn-sm btn-primary mx-2">Start</button>
    </nav>

    <div id="map"></div>
    <img id="car" src="NicePng_car-top-view-png_544632 2.png" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script>
        var graph = [];
        var fillType = 1;
        const col = window.innerWidth / 30;
        const row = (window.innerHeight - 60) / 30;

        function setupMap() {
            // filling graph with 0 and setting col & rows
            for (var i = 0; i < row; i++) {
                graph.push([]);
                for (var j = 0; j < col; j++) {
                    graph[i].push(0);
                }
            }

            // add cells to map with onclick events
            var map = $("#map");
            for (var i = 0; i < graph.length; i++) {
                var currentRow = $(`<div id="row-${i}" class="d-flex justify-items-center"></div>`).appendTo(map);
                for (var j = 0; j < graph[0].length; j++) {
                    currentRow.append(`<div id="cell-${i}-${j}" class="square" onclick='handleClick(${i}, ${j})'></div>`);
                }
            }
        }

        // function handleFillTypeChange() {
        //     fillType = parseInt($('input[name="fillType"]:checked').val());
        //     console.log(fillType);
        // }

        function handleClick(i, j) {
            if (graph[i][j] == 0) {
                graph[i][j] = 1;
                $(`#cell-${i}-${j}`).css({ 'background': getFillColor(1) });
            } else if (graph[i][j] == 1) {
                graph[i][j] = 2;
                $(`#cell-${i}-${j}`).css({ 'background': getFillColor(2) });
            } else {
                graph[i][j] = 0;
                $(`#cell-${i}-${j}`).css({ 'background': getFillColor(0) });
            }
            console.log(i, j);
        }

        function getFillColor(fillType) {
            // 0 - empty space
            // 1 - road
            // 2 - building 
            if (fillType == 0) {
                return "#F8F7F2";
            } else if (fillType == 1) {
                return "#ced4da";
            } else if (fillType == 2) {
                return "#495057";
            }
        }




        $(document).ready(function () {
            setupMap();
        });

        class Node {
            constructor(parent, x, y) {
                this.parent = parent;
                this.x = x;
                this.y = y;
            }

            equals(other) {
                return this.x == other.x && this.y == other.y;
            }
        }

        function bfs() {
            var visited = [];
            for (var i = 0; i < row; i++) {
                visited.push([]);
                for (var j = 0; j < col; j++) {
                    visited[i].push(0);
                }
            }

            var queue = [];
            var currentNode = new Node(null, 0, 0);
            var targetNode = new Node(null, 5, 5);
            queue.push(currentNode);
            while (queue.length > 0) {
                currentNode = queue.shift();;
                // mark currentNode as visited
                visited[currentNode.x][currentNode.y] = 1;

                // check if current node is target node return the path
                if (currentNode.equals(targetNode)) {
                    var path = [];
                    var current = currentNode;
                    while (current != null) {
                        path.push(current);
                        current = current.parent;
                    }
                    return path.reverse();
                }

                // find adjacent neighbors of current node 
                var neighbors = [];
                var adjacentPositions = [[0, 1], [1, 0], [-1, 0], [0, -1]];
                for (var adjacent of adjacentPositions) {
                    var i = currentNode.x + adjacent[0];
                    var j = currentNode.y + adjacent[1];
                    if (i >= 0 && i < row && j >= 0 && j < col && visited[i][j] != 1) {
                        neighbors.push(new Node(currentNode, i, j));
                    }
                }
                // add all valid childs to queue
                for (const neighbor of neighbors) {
                    queue.push(neighbor);
                }
            }
        }

        var car = document.getElementById("car");
        var prev = new Node(null, 0, 0);
        var dir = 0;

        function moveCar(i, currentX, currentY) {
            setTimeout(function () {
                car.style["top"] = `${currentX}px`;
                car.style["left"] = `${currentY}px`;
            }, 20 * i);
        }
        function radToDegree(rad) {
            return (rad * 180) / Math.PI;
        }
        function drawPath(i, node) {
            setTimeout(function () {
                var cell = $(`#cell-${node.x}-${node.y}`);
                cell.css('background-color', '#FFF47D');
                cell.animate({ opacity: '0.5' }, "slow");
                cell.animate({ opacity: '1' }, "slow");
            }, i * 50);
        }
        function task(i, node) {
            setTimeout(function () {
                var cell = $(`#cell-${node.x}-${node.y}`);
                cell.css('background-color', '#F8F7F2');

                var dy = node.x - prev.x;
                var dx = node.y - prev.y;
                dir = radToDegree(Math.atan2(dy, dx));
                car.style["transform"] = `rotate(${dir}deg)`;
                var currentX = node.x * 30 + 35;
                var currentY = node.y * 30 - 15;
                for (var j = 0; j < 30; j++) {
                    moveCar(j, currentX + j * dy, currentY + j * dx);
                }
                prev = node;
            }, 600 * i);
        }

        function precompute() {
            var path = bfs();
            var i = 0;
            for (var node of path) {
                drawPath(i++, node);
            }
            i = 0;
            for (var node of path) {
                task(i++, node);
            }
        }

    </script>
</body>

</html>